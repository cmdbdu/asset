$(document).ready(function (){
  $('.glyphicon-plus').on('click',function(){
    var ids = $(this).parent().parent().attr('id')
    $('.secondlayer').attr('data-appid',ids);
    });
  $('.bind_device_property').on('click',function() {
      bind_device_property($(this));
    });
  select_product_type()
  $('#id_words').change(function () {
    var new_array = $(this).attr('value').split('\\');
    $('#textfield').val(new_array[new_array.length - 1]);
     return false; 
  });

  $('#id_product_type').change(function (){
    select_product_type();
  });
  $('#id_property_name').change(function (){
    select_product_type();
  });
  $('#id_oem').change(function (){
    select_oem();
  });
})

// 根据选择的产品不同，修改产品版本，和产品模块信息
function select_product_type(){
  var property_key_list = {'加密狗':'key', '证书':'license'}
  var property_server_list = {'DELL R210':'dellr210', 'DELL R520':'dellr520',
                              '其他':'other'}
  var property_icp_list = {'低端':'low','高端':'high'}
  var product_websoc_version = {'4.1': '4.1', '4.2': '4.2', '4.3': '4.3'};
  var product_websaber_version = {'none': 'none'};
  var product_waf_version = {'P300S': 'P300S', 'P600S': 'P600S', 'P1000S': 'P100S',
                              'P2500S': 'P1500S', 'P2000S': 'P2000S', 'P6000S': 'P6000S'};

  var product_models = {
                    'availability': '可用性' , 'content': '安全事件', 
                    'weakness': '漏洞', 'analysis': '综合报表数据分析',
                    'poc': 'Web漏洞自动验证', 'api': '二次开发接口',
                    'multiuser': '安全增值服务', 'distribute': '集群部署',
                    'gsm_modem': '短信通知', 'hostscan': '站点发现',
                    'black_links': '暗链', 'malscan': '挂马', 'keyword': '关键词',
                    'deface': '变更', 'webvul': 'Web应用漏洞'
                    };
    if($('#id_product_type').val() == 'WebSOC'){
      var content;
      for ( var version in product_websoc_version){
        content += "<option>"+version+"</option>"
      };
      $('#id_product_version').html(content);
      $('#id_approval_models').html("监控网站数量:100 \n用户数量：12 \n\n1.默认模块：可用性检测，综合报表数据分析模块，多用户，\n安全事件[暗链，挂马，关键词，变更],漏洞[应用漏洞]，\nWEB漏洞自动验证模块。\n2.付费模块：二次开发，短信模块，集群模块，截图模块，站点发现");
      }
      else if($('#id_product_type').val() == 'WebSaber'){
        var content;
        for ( var version in product_websaber_version){
          content += "<option>"+version+"</option>"
        };
        $('#id_product_version').html(content);
        $('#id_approval_models').html('none');
      }
      else{
        var content;
        for ( var version in product_waf_version){
          content += "<option>"+version+"</option>"
        };
        $('#id_product_version').html(content);
        $('#id_approval_models').html('none');
    };
  if($('#id_property_name').val() == 'key'){
    var property_type;
    for (var item in property_key_list){
      property_type += "<option value="+property_key_list[item]+">" +item+"</option>"};
    $('#id_property_type').html(property_type);
    }
    else if($('#id_property_name').val() == 'server'){
      var property_type;
      for (var item in property_server_list){
        property_type += "<option value="+property_server_list[item]+">" +item+"</option>"};
    $('#id_property_type').html(property_type);
    }
    else{
      var property_type;
      for (var item in property_icp_list){
        property_type += "<option value="+property_icp_list[item]+">" +item+"</option>"};
    $('#id_property_type').html(property_type);
  };
};

function select_oem(){
  var check = document.getElementById('id_oem')
  if(check.checked == false){
    $('#id_factory_name').attr('disabled',true); 
    $('#id_factory_linkman').attr('disabled',true); 
    $('#id_factory_mobile').attr('disabled',true); 
  }
  else if(check.checked == true){
    $('#id_factory_name').attr('disabled',false); 
    $('#id_factory_linkman').attr('disabled',false); 
    $('#id_factory_mobile').attr('disabled',false); 
  };
}

function bind_device_property(button){
  var data  = {'id': button.data('id'), 
      'type': button.data('type'),
      'appid':button.parent().parent().parent().parent().data('appid'),
      'status': button.data('status'),
      'url': window.location.href};
    console.log(data)
    $.ajax({
      type : 'get',
      data : data,
      url : 'business/bind_device_property/',
      success : function (a){
        datas = eval('(' + a + ')')
        var dev_show = $("#using_device_show");
            lic_show = $("#using_license_show")
            url_show_property = '<a href="#" id="'+datas["pid"]+'">'+datas["mark"]+'</a><br/>';
        if (datas['status'] == 'bind'){
          button.data('status','unbind')
          button.html('解除绑定');
          if (datas["ptype"] == "device"){
            dev_show.append(url_show_property);
            }else{
            lic_show.append(url_show_property);
            }
          }
        else if(datas['status'] == 'unbind'){
          $('a#' + datas['pid']).parent().html('');
          button.data('status','bind');
          button.html('绑定');}
        }   
      })
  }
